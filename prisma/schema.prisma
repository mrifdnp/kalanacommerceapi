// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid()) @db.Uuid

  name        String
  email       String        @unique
  password    String
  phoneNumber String?       @unique @map("phone_number")
  balance     Decimal       @default(0.00) @db.Decimal(12, 2)
  addresses   UserAddress[]
  outlets     Outlet[]
  cart        Cart?
  orders      Order[]
  image       String?

  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  resetToken        String?
  resetTokenExpires DateTime?

  @@map("user")
}

model UserAddress {
  id     String @id @default(uuid())
  userId String @map("user_id") @db.Uuid // Kunci asing ke User

  // Konten Alamat
  label         String // Contoh: "Rumah", "Kantor", "Ibu"
  recipientName String @map("recipient_name")
  phoneNumber   String @map("phone_number") // Nomor kontak di alamat tersebut
  street        String
  postalCode    String @map("postal_code")

  // Data Lokasi
  provincesId String
  citiesId    String
  districtsId String
  deletedAt   DateTime?
  // Lokasi GPS (opsional, tapi berguna)
  long        Decimal?  @db.Decimal(10, 7)
  lat         Decimal?  @db.Decimal(10, 7)

  isDefault Boolean @default(false) @map("is_default") // Apakah ini alamat utama?

  // Relasi
  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_address")
}

// --- 2. MODEL UTAMA: Outlet (Lokasi Penjualan) ---
model Outlet {
  id     String  @id @default(uuid())
  userId String? @map("user_id") @db.Uuid

  name        String
  provincesId String?
  citiesId    String?
  districtsId String?
  long        Decimal? @db.Decimal(10, 7)
  lat         Decimal? @db.Decimal(10, 7)

  settings       Json?
  businessTypeId String?

  // Relasi
  user      User?     @relation(fields: [userId], references: [id])
  products  Product[] // Relasi 1:M (Outlet memiliki banyak Product)
  units     Unit[] // Unit milik Outlet ini
  orders    Order[]
  // Kolom Audit
  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("outlet")
}

// --- 3. MODEL MASTER: Category ---
model Category {
  id   String @id @default(uuid())
  name String

  products Product[]

  // Kolom Audit
  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("category")
}

// --- 4. MODEL MASTER: Unit ---
model Unit {
  id       String           @id @default(uuid())
  outletId String?
  name     String
  variants ProductVariant[]
  products Product[]
  outlet   Outlet?          @relation(fields: [outletId], references: [id])

  // Kolom Audit
  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("unit")
}

model Product {
  id         String  @id @default(uuid())
  outletId   String? @map("outlet_id")
  categoryId String? @map("category_id")
  unitId     String? @map("unit_id") // Unit dasar

  productCode String  @unique @map("product_code")
  name        String
  description String? @db.Text
  image       String?

  // Stok Induk (misal dalam gram atau pcs)
  qty Int @default(0)

  cogs           Decimal @default(0) @db.Decimal(10, 2)
  freshnessLevel Int     @default(100) @map("freshness_level")
  isPublished    Boolean @default(true) @map("is_published")
  tags           String?

  moq                Int?      @default(1)
  isMaterial         Boolean   @default(false) @map("is_material")
  materialCategoryId String?   @map("material_category_id")
  expiryDate         DateTime? @map("expiry_date")
  batch              String?
  sku                String?

  // Relasi
  variants ProductVariant[] // Relasi ke pilihan harga (1, 2, 3)
  outlet   Outlet?          @relation(fields: [outletId], references: [id])
  category Category?        @relation(fields: [categoryId], references: [id])
  unit     Unit?            @relation(fields: [unitId], references: [id])

  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("product")
}

// --- MODEL BARU: ProductVariant (Pilihan Harga & Unit) ---
model ProductVariant {
  id          String @id @default(uuid())
  productId   String @map("product_id")
  unitId      String @map("unit_id")
  variantName String @map("variant_name") // Contoh: "1 kg", "500 gr"

  price         Decimal  @db.Decimal(10, 2)
  originalPrice Decimal? @map("original_price") @db.Decimal(10, 2) // Harga coret

  // Nilai untuk memotong stok (misal: "1 kg" -> 1000)
  qtyMultiplier Int @default(1) @map("qty_multiplier")

  product    Product     @relation(fields: [productId], references: [id])
  unit       Unit        @relation(fields: [unitId], references: [id])
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@map("product_variant")
}

// --- 6. MODEL KERANJANG ---
model Cart {
  id     String @id @default(uuid())
  userId String @unique @map("user_id") @db.Uuid

  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cart")
}

model CartItem {
  id               String @id @default(uuid())
  cartId           String @map("cart_id")
  productVariantId String @map("product_variant_id") // Hubungkan ke Varian
  quantity         Int

  cart    Cart           @relation(fields: [cartId], references: [id])
  variant ProductVariant @relation(fields: [productVariantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productVariantId])
  @@map("cart_item")
}

model Order {
  id              String  @id @default(uuid())
  userId          String  @map("user_id") @db.Uuid
  outletId        String  @map("outlet_id")
  orderCode       String  @unique
  totalAmount     Int
  netAmount       Int
  status          String  @default("PENDING") // PENDING, PAID, CANCELLED, EXPIRED
  paymentMethod   String?
  paymentGroupId  String?
  // Field Tambahan untuk Midtrans
  snapToken       String? @map("snap_token")
  snapRedirectUrl String? @map("snap_redirect_url")

  user   User        @relation(fields: [userId], references: [id])
  outlet Outlet      @relation(fields: [outletId], references: [id])
  items  OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("order")
}

enum PickupStatus {
  WAITING_DRIVER
  PICKUP
  DELIVERING
  COMPLETED
  CANCELLED
}

model OrderItem {
  id               String         @id @default(uuid())
  orderId          String         @map("order_id")
  productVariantId String         @map("product_variant_id")
  quantity         Int
  priceAtPurchase  Decimal        @db.Decimal(10, 2)
  subtotal         Decimal        @db.Decimal(10, 2)
  pickupStatus     PickupStatus   @default(WAITING_DRIVER)
  order            Order          @relation(fields: [orderId], references: [id])
  variant          ProductVariant @relation(fields: [productVariantId], references: [id])

  createdAt DateTime @default(now())

  @@map("order_item")
}
