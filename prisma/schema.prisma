// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid()) @db.Uuid

  name     String
  email    String @unique
  password String
  phoneNumber String?   @unique @map("phone_number")
  balance Decimal @default(0.00) @db.Decimal(12, 2)
  addresses UserAddress[]
  outlets Outlet[]
  cart    Cart?
  orders  Order[]
  image       String?
  
  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  resetToken       String?
  resetTokenExpires DateTime?

  @@map("user")
}
model UserAddress {
  id String @id @default(uuid())
  userId String @map("user_id") @db.Uuid // Kunci asing ke User

  // Konten Alamat
  label String // Contoh: "Rumah", "Kantor", "Ibu"
  recipientName String @map("recipient_name")
  phoneNumber String @map("phone_number") // Nomor kontak di alamat tersebut
  street String
  postalCode String @map("postal_code")
  
  // Data Lokasi
  provincesId String
  citiesId String
  districtsId String
  deletedAt   DateTime?
  // Lokasi GPS (opsional, tapi berguna)
  long Decimal? @db.Decimal(10, 7)
  lat Decimal? @db.Decimal(10, 7)

  isDefault Boolean @default(false) @map("is_default") // Apakah ini alamat utama?

  // Relasi
  user User @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("user_address")
}

// --- 2. MODEL UTAMA: Outlet (Lokasi Penjualan) ---
model Outlet {
  id     String  @id @default(uuid())
  userId String? @map("user_id") @db.Uuid

  name        String
  provincesId String?
  citiesId    String?
  districtsId String?
  long        Decimal? @db.Decimal(10, 7)
  lat         Decimal? @db.Decimal(10, 7)

  settings       Json?
  businessTypeId String?

  // Relasi
  user      User?     @relation(fields: [userId], references: [id])
  products  Product[] // Relasi 1:M (Outlet memiliki banyak Product)
  units     Unit[] // Unit milik Outlet ini
  orders    Order[]
  // Kolom Audit
  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("outlet")
}

// --- 3. MODEL MASTER: Category ---
model Category {
  id   String @id @default(uuid())
  name String

  products Product[]

  // Kolom Audit
  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("category")
}

// --- 4. MODEL MASTER: Unit ---
model Unit {
  id          String    @id @default(uuid())
  outletId    String?
  name        String
  
  products    Product[]
  outlet      Outlet?   @relation(fields: [outletId], references: [id])

  // Kolom Audit
  createdBy String?
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("unit")
}

// --- 5. MODEL UTAMA: Product (Master Produk dengan Stok Global) ---
model Product {
  id         String  @id @default(uuid())
  outletId   String? @map("outlet_id")
  categoryId String? @map("category_id")
  unitId     String? @map("unit_id") // ⬅️ Unit ID dipertahankan

  productCode String  @unique @map("product_code")
  name        String
  description String?
  image       String?

  // Stok dan Harga
  qty             Int      @default(0) // ⬅️ Stok Global/Total Ditambahkan
  cogs Decimal @default(0) @db.Decimal(10, 2)
  price           Decimal  @default(0) @map("price_1") @db.Decimal(10, 2)
  discountNominal Decimal? @map("discount_nominal_1") @db.Decimal(10, 2)
  discountPercent Decimal? @map("discount_percent_1") @db.Decimal(5, 2)
  freshnessLevel Int @default(100) @map("freshness_level")
  isPublished Boolean @default(true) @map("is_published")
  tags        String?

  // Material & Batch (Detail ini tetap ada, namun kurang relevan tanpa Stock terpisah)
  moq                Int?      @default(1)
  isMaterial         Boolean   @default(false) @map("is_material")
  materialCategoryId String?   @map("material_category_id")
  expiryDate         DateTime? @map("expiry_date")
  batch              String?
  sku                String?

  // Relasi
  outlet     Outlet?     @relation(fields: [outletId], references: [id])
  category   Category?   @relation(fields: [categoryId], references: [id])
  unit       Unit?       @relation(fields: [unitId], references: [id])
  cartItems  CartItem[]
  orderItems OrderItem[]
  // Kolom Audit & Soft Delete
  createdBy  String?
  deletedAt  DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@map("product")
}

model Cart {
  id     String @id @default(uuid())
  userId String @unique @map("user_id") @db.Uuid

  // Relasi
  user  User       @relation(fields: [userId], references: [id])
  items CartItem[] // Cart memiliki banyak CartItem

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cart")
}

// --- MODEL BARU: CartItem (Item di Keranjang) ---
model CartItem {
  id        String @id @default(uuid())
  cartId    String @map("cart_id")
  productId String @map("product_id")
  quantity  Int

  // Relasi
  cart    Cart    @relation(fields: [cartId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Memastikan satu produk hanya muncul satu kali di satu Cart
  @@unique([cartId, productId])
  @@map("cart_item")
}

model Order {
  id       String @id @default(uuid())
  userId   String @map("user_id") @db.Uuid
  outletId String @map("outlet_id") // Outlet Penjual

  orderCode   String @unique
  totalAmount Int // Subtotal item di Order ini
  netAmount   Int // Total setelah diskon (Final amount)

  status        String  @default("PENDING")
  paymentMethod String?

  // Relasi
  user   User        @relation(fields: [userId], references: [id])
  outlet Outlet      @relation(fields: [outletId], references: [id])
  items  OrderItem[] // Order memiliki banyak OrderItem

  // Kolom Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("order")
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String @map("order_id")
  productId String @map("product_id")

  quantity Int
  subtotal Decimal @db.Decimal(10, 2)

  // Relasi
  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())

  @@map("order_item")
}
